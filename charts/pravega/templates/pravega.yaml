apiVersion: "pravega.pravega.io/v1beta1"
kind: "PravegaCluster"
metadata:
  name: {{ template "pravega.fullname" . }}
  labels:
    app.kubernetes.io/name: "pravega-cluster"
spec:
  {{- if .Values.tls }}
  tls:
    static:
      controllerSecret: {{ .Values.tls.secret.controller }}
      segmentStoreSecret: {{ .Values.tls.secret.segmentStore }}
      caBundle: {{ .Values.tls.caBundle }}
  {{- end }}
  {{- if .Values.authentication }}
  authentication:
    enabled: {{ .Values.authentication.enabled }}
    passwordAuthSecret: {{ .Values.authentication.passwordAuthSecret }}
  {{- end }}
  version: {{ .Values.version }}
  zookeeperUri: {{ .Values.zookeeperUri }}
  bookkeeperUri: {{ .Values.bookkeeperUri }}
  {{- if .Values.externalAccess }}
  externalAccess:
    enabled: {{ .Values.externalAccess.enabled }}
    type: {{ .Values.externalAccess.type }}
    domainName: {{ .Values.externalAccess.domainName }}
  {{- end }}
  pravega:
    {{- if .Values.externalAccess }}
    {{- if .Values.externalAccess.enabled }}
    controllerServiceAccountName: {{ .Values.serviceAccount.name }}
    segmentStoreServiceAccountName: {{ .Values.serviceAccount.name }}
    {{- end }}
    {{- end }}
    image:
      repository: {{ .Values.image.repository }}
      pullPolicy: {{ .Values.image.pullPolicy }}
    controllerReplicas: {{ .Values.controller.replicas }}
    {{- if .Values.controller.resources }}
    controllerResources:
      requests:
        memory: {{ .Values.controller.resources.requests.memory | quote }}
        cpu: {{ .Values.controller.resources.requests.cpu | quote }}
      limits:
        memory: {{ .Values.controller.resources.limits.memory | quote }}
        cpu: {{ .Values.controller.resources.limits.cpu | quote }}
    {{- end }}
    segmentStoreReplicas: {{ .Values.segmentStore.replicas }}
    {{- if .Values.segmentStore.resources }}
    segmentStoreResources:
      requests:
        memory: {{ .Values.segmentStore.resources.requests.memory | quote }}
        cpu: {{ .Values.segmentStore.resources.requests.cpu | quote }}
      limits:
        memory: {{ .Values.segmentStore.resources.limits.memory | quote }}
        cpu: {{ .Values.segmentStore.resources.limits.cpu | quote }}
    {{- end }}
    {{- if .Values.segmentStore.env }}
    segmentStoreEnvVars: {{ .Values.segmentStore.env }}
    {{- end }}
    {{- if .Values.segmentStore.secret }}
    segmentStoreSecret:
      secret: {{ .Values.segmentStore.name }}
      mountPath: {{ .Values.segmentStore.path }}
    {{- end }}
    {{- if .Values.controller.service }}
    controllerExtServiceType: {{ .Values.controller.service.type }}
    controllerSvcAnnotations: {{ .Values.controller.service.annotations }}
    {{- end }}
    {{- if .Values.segmentStore.service }}
    segmentStoreExtServiceType: {{ .Values.segmentStore.service.type }}
    segmentStoreSvcAnnotations: {{ .Values.segmentStore.service.annotations }}
    {{- end }}
    controllerjvmOptions: {{ .Values.controller.jvmOptions }}
    segmentStoreJVMOptions: {{ .Values.segmentStore.jvmOptions }}
    debugLogging: {{ .Values.debugLogging }}
    {{- if .Values.storage.cache }}
    cacheVolumeClaimTemplate:
      accessModes: [ "ReadWriteOnce" ]
      storageClassName: {{ .Values.storage.cache.className }}
      resources:
        requests:
          storage: {{ .Values.storage.cache.size }}
    {{- end }}
    longtermStorage:
      {{- if eq .Values.storage.longtermStorage.className "ecs"}}
      ecs:
        configUri: {{ .Values.storage.longtermStorage.ecs.configUri }}
        bucket: {{ .Values.storage.longtermStorage.ecs.bucket }}
        prefix: {{ .Values.storage.longtermStorage.ecs.prefix }}
        credentials: {{ .Values.storage.longtermStorage.ecs.credentials }}
      {{- else if eq .Values.storage.longtermStorage.className "hdfs"}}
      hdfs:
        uri: {{ .Values.storage.longtermStorage.hdfs.uri }}
        root: {{ .Values.storage.longtermStorage.hdfs.root }}
        replicationFactor: {{ .Values.storage.longtermStorage.hdfs.replicationFactor }}
      {{- else }}
      filesystem:
        persistentVolumeClaim:
          claimName: {{ .Values.storage.longtermStorage.filesystem.pvc }}
      {{- end }}
    {{- if .Values.options.enabled }}
    options:
      {{- range .Values.options.properties }}
      {{ .key }} : {{ .value | quote }}
      {{- end }}
    {{- end }}
